{% extends "_layouts/cp" %}
{% set title = "Spaghetti Migrator" %}
{% set fullPageForm = false %}

{% block content %}

<div id="migration-dashboard" class="migration-dashboard">

    {# Header Section #}
    <div class="migration-header">
        <div class="migration-header-content">
            <h1>üçù Spaghetti Migrator</h1>
            <p class="migration-subtitle">Untangle your nested folders and migrate assets between cloud services with ease</p>
        </div>

        <div class="migration-header-status">
            <div class="status-badge" data-status="{{ state.currentPhase }}">
                <span class="status-dot"></span>
                <span class="status-text">Phase {{ state.currentPhase }} of 8</span>
            </div>
        </div>
    </div>

    {# Workflow Stepper #}
    <div class="workflow-stepper">
        <div class="stepper-step" data-phase="0">
            <div class="step-number">0</div>
            <div class="step-label">Setup</div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step" data-phase="1">
            <div class="step-number">1</div>
            <div class="step-label">Checks</div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step" data-phase="2">
            <div class="step-number">2</div>
            <div class="step-label">URLs</div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step" data-phase="3">
            <div class="step-number">3</div>
            <div class="step-label">Templates</div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step critical" data-phase="4">
            <div class="step-number">4</div>
            <div class="step-label">Switch FS</div>
            <div class="step-icon" aria-label="Critical step"><span aria-hidden="true">‚ö†Ô∏è</span></div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step critical" data-phase="5">
            <div class="step-number">5</div>
            <div class="step-label">Migrate</div>
            <div class="step-icon" aria-label="Migration step"><span aria-hidden="true">üì¶</span></div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step" data-phase="6">
            <div class="step-number">6</div>
            <div class="step-label">Validate</div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step" data-phase="7">
            <div class="step-number">7</div>
            <div class="step-label">Transforms</div>
        </div>
    </div>

    {# Critical Order Warning #}
    <div class="order-warning-banner" role="alert">
        <div class="warning-icon" aria-hidden="true">‚ö†Ô∏è</div>
        <div class="warning-content">
            <h4>Critical Workflow Order</h4>
            <p><strong>IMPORTANT:</strong> Phase 4 (Filesystem Switch) MUST be completed BEFORE Phase 5 (File Migration). Switching filesystems first ensures volumes point to DigitalOcean during migration.</p>
        </div>
    </div>

    {# Configuration Status #}
    <div class="config-status-section">
        <div class="config-status-card">
            <h3>Configuration Status</h3>
            <div class="config-status-grid">
                <div class="config-item {{ config.hasDoCredentials ? 'config-ok' : 'config-missing' }}">
                    <span class="config-icon">{{ config.hasDoCredentials ? '‚úì' : '‚úó' }}</span>
                    <span class="config-label">DO Credentials</span>
                </div>
                <div class="config-item {{ config.hasDoBucket ? 'config-ok' : 'config-missing' }}">
                    <span class="config-icon">{{ config.hasDoBucket ? '‚úì' : '‚úó' }}</span>
                    <span class="config-label">DO Bucket</span>
                </div>
                <div class="config-item {{ config.hasAwsConfig ? 'config-ok' : 'config-missing' }}">
                    <span class="config-icon">{{ config.hasAwsConfig ? '‚úì' : '‚úó' }}</span>
                    <span class="config-label">AWS Config</span>
                </div>
                <div class="config-item {{ config.hasDoUrl ? 'config-ok' : 'config-missing' }}">
                    <span class="config-icon">{{ config.hasDoUrl ? '‚úì' : '‚úó' }}</span>
                    <span class="config-label">DO Base URL</span>
                </div>
            </div>

            {% if config.isConfigured %}
            <div class="config-details">
                <div class="config-detail-row">
                    <span class="config-detail-label">AWS Bucket:</span>
                    <span class="config-detail-value">{{ config.awsBucket }}</span>
                </div>
                <div class="config-detail-row">
                    <span class="config-detail-label">DO Bucket:</span>
                    <span class="config-detail-value">{{ config.doBucket }}</span>
                </div>
            </div>
            {% endif %}

            <div class="config-actions">
                <button type="button" class="btn submit" id="live-monitor-btn">
                    <span aria-hidden="true">üìä</span> Live Monitor
                </button>
                <button type="button" class="btn" id="test-connection-btn">Test DO Connection</button>
                <a href="{{ url('settings/filesystems') }}" class="btn secondary">View Filesystems</a>
            </div>

            {# Execution Mode Toggle #}
            <div class="config-detail-row" style="margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 6px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="execution-mode-toggle" checked style="width: 18px; height: 18px;">
                    <span style="font-weight: 500;">Use SSE Streaming with Polling</span>
                    <span style="font-size: 12px; color: #6b7280;">(Recommended - doesn't block PHP workers)</span>
                </label>
                <p style="margin: 8px 0 0 26px; font-size: 12px; color: #6b7280;">
                    SSE spawns process then polls for updates (non-blocking). Queue uses Craft's job system (also non-blocking). Both modes allow Control Panel to remain responsive.
                </p>
            </div>
        </div>

        {# Resume Banner #}
        {% if state.canResume %}
        <div class="resume-banner" role="status">
            <div class="resume-banner-icon" aria-hidden="true">‚è∏Ô∏è</div>
            <div class="resume-banner-content">
                <h4>Migration checkpoint detected</h4>
                <p>A previous migration was interrupted. You can resume from where you left off.</p>
            </div>
            <div class="resume-banner-actions">
                <button type="button"
                        class="btn submit run-module-btn"
                        data-command="image-migration/migrate"
                        data-supports-resume="true"
                        data-resume="true">Resume Migration</button>
                <button type="button" class="btn secondary" id="view-checkpoint-btn">View Checkpoint</button>
            </div>
        </div>
        {% endif %}
    </div>

    {# Quick Guide Section #}
    <div class="module-group" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-color: #93c5fd;">
        <div class="module-group-header" style="border-bottom-color: #93c5fd;">
            <span class="module-group-icon" aria-hidden="true">‚ÑπÔ∏è</span>
            <h3 class="module-group-title">How to Use This Dashboard</h3>
        </div>
        <div class="module-group-description" style="margin-bottom: 0;">
            <p style="margin: 0 0 12px 0;"><strong>This dashboard guides you through a complete AWS S3 ‚Üí DigitalOcean Spaces migration.</strong></p>
            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                <li><strong>‚å®Ô∏è Manual CLI steps</strong> require terminal commands and can be marked as completed when done</li>
                <li><strong>‚ñº Collapsible phases</strong> can be expanded/collapsed by clicking the phase header</li>
                <li><strong>‚úì Green checkmarks</strong> indicate completed steps - your progress is automatically saved</li>
                <li><strong>‚ö†Ô∏è Critical steps</strong> must be done in order - the dashboard will warn you if prerequisites are missing</li>
                <li><strong>üìã View logs</strong> button lets you see detailed output from each command</li>
                <li><strong>Progress bar</strong> shows real-time execution progress for running commands</li>
            </ul>
        </div>
    </div>

    {# Maintenance & Diagnostics Section #}
    <div class="module-group" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #fbbf24;">
        <div class="module-group-header" style="border-bottom-color: #fbbf24;">
            <span class="module-group-icon" aria-hidden="true">üîß</span>
            <h3 class="module-group-title">Maintenance & Diagnostics</h3>
        </div>
        <div class="module-group-description">
            <p style="margin: 0 0 12px 0;"><strong>Analyze and fix issues with missing asset files.</strong></p>
            <div class="config-actions" style="margin-top: 16px;">
                <button type="button" class="btn secondary" id="analyze-missing-files-btn">
                    <span aria-hidden="true">üîç</span> Analyze Missing Files
                </button>
                <button type="button" class="btn" id="fix-missing-files-btn" style="display: none;">
                    <span aria-hidden="true">üîß</span> Fix Missing Files (Dry Run)
                </button>
                <button type="button" class="btn submit" id="fix-missing-files-actual-btn" style="display: none;">
                    <span aria-hidden="true">‚ú®</span> Fix Missing Files
                </button>
            </div>

            {# Analysis Results #}
            <div id="missing-files-results" style="display: none; margin-top: 20px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #d1d5db;">
                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #374151;">Analysis Results</h4>
                <div id="missing-files-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                    {# Stats will be populated by JavaScript #}
                </div>
                <div id="missing-files-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 8px;">
                    {# File list will be populated by JavaScript #}
                </div>
            </div>

            {# Fix Results #}
            <div id="fix-results" style="display: none; margin-top: 20px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #d1d5db;">
                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #374151;">Fix Results</h4>
                <div id="fix-results-content">
                    {# Results will be populated by JavaScript #}
                </div>
            </div>
        </div>
    </div>

    {# Migration Steps #}
    <div class="migration-phases">
        {% for phase in modules %}
        <div class="phase-section" data-phase-id="{{ phase.id }}">
            <div class="phase-header">
                <div class="phase-number">Phase {{ phase.phase }}</div>
                <div class="phase-info">
                    <h2 class="phase-title">{{ phase.title }}</h2>
                    <div class="phase-module-count">{{ phase.modules|length }} module{{ phase.modules|length > 1 ? 's' : '' }}</div>
                </div>
            </div>

            <div class="phase-modules">
                {% for module in phase.modules %}
                <div class="module-card {% if module.requiresArgs %}manual-step{% endif %}" data-module-id="{{ module.id }}" data-command="{{ module.command }}">
                    <div class="module-header">
                        <div class="module-status-icon">
                            <span class="status-indicator"></span>
                        </div>
                        <div class="module-info">
                            <h3 class="module-title">
                                {{ module.title }}
                                {% if module.critical %}
                                <span class="badge critical-badge">Critical</span>
                                {% endif %}
                                {% if module.requiresArgs %}
                                <span class="manual-step-badge">
                                    <span aria-hidden="true">‚å®Ô∏è</span> Manual CLI
                                </span>
                                {% endif %}
                            </h3>
                            <div class="module-description">{{ module.description|raw }}</div>
                        </div>
                        <div class="module-meta">
                            <span class="module-duration"><span aria-hidden="true">‚è±Ô∏è</span> {{ module.duration }}</span>
                        </div>
                    </div>

                    <div class="module-actions">
                        {% if module.supportsDryRun and not module.requiresArgs %}
                        <button type="button"
                                class="btn secondary run-module-btn"
                                data-command="{{ module.command }}"
                                data-dry-run="true">
                            Dry Run
                        </button>
                        {% endif %}

                        <button type="button" class="btn icon-only copy-command-btn"
                                {% if module.command %}data-command="php craft spaghetti-migrator/{{ module.command }}"{% endif %}
                                aria-label="Copy CLI command for {{ module.title }}">
                            <span class="log-icon" aria-hidden="true">üìã</span>
                        </button>

                        <button type="button"
                                class="btn submit run-module-btn primary-action-btn"
                                data-command="{{ module.command }}"
                                {% if module.supportsDryRun %}data-dry-run="false"{% endif %}
                                {% if module.supportsResume %}data-supports-resume="true"{% endif %}
                                {% if module.requiresArgs %}data-manual-step="true"{% endif %}>
                            {% if module.requiresArgs %}
                                ‚úì Mark as Completed
                            {% else %}
                                Run {{ module.title }}
                            {% endif %}
                        </button>
                    </div>

                    {# Progress Section (hidden by default) #}
                    <div class="module-progress" style="display: none;">
                        <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Module execution progress">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-info">
                            <span class="progress-text">Starting...</span>
                            <span class="progress-percent">0%</span>
                        </div>
                        <div class="progress-actions">
                            <button type="button" class="btn small error cancel-module-btn" style="display: none;" aria-label="Cancel module execution">
                                Cancel
                            </button>
                        </div>
                    </div>

                    {# Stats Section (hidden by default) #}
                    <div class="module-stats" style="display: none;">
                        <div class="stats-header">
                            <h4>Migration Statistics</h4>
                        </div>
                        <div class="stats-grid"></div>
                    </div>

                    {# Output Section (hidden by default) #}
                    <div class="module-output" style="display: none;">
                        <div class="output-header">
                            <h4>Output</h4>
                            <button type="button" class="btn small clear-output-btn">Clear</button>
                        </div>
                        <pre class="output-content"></pre>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    {# Rollback Section #}
    <div class="rollback-section">
        <div class="rollback-card">
            <h3><span aria-hidden="true">‚ö†Ô∏è</span> Rollback & Recovery</h3>
            <p>If something goes wrong, you can rollback the migration to a previous state.</p>
            <div class="rollback-actions">
                <button type="button" class="btn error" id="rollback-btn">Rollback Migration</button>
                <button type="button" class="btn secondary" id="view-changelog-btn">View Change Log</button>
            </div>
        </div>
    </div>
</div>

{# Accessibility: Screen reader announcements #}
<div id="sr-announcements" class="sr-only" role="status" aria-live="polite" aria-atomic="true"></div>

{# Modals #}
<div id="output-modal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="output-modal-title" aria-describedby="modal-output-content">
    <div class="modal-container">
        <div class="modal-header">
            <h3 id="output-modal-title" class="modal-title">Command Output</h3>
            <button type="button" class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body">
            <pre id="modal-output-content"></pre>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn secondary modal-close">Close</button>
        </div>
    </div>
</div>

<div id="checkpoint-modal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="checkpoint-modal-title" aria-describedby="checkpoint-list">
    <div class="modal-container">
        <div class="modal-header">
            <h3 id="checkpoint-modal-title" class="modal-title">Migration Checkpoints</h3>
            <button type="button" class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body">
            <div id="checkpoint-list"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn secondary modal-close">Close</button>
        </div>
    </div>
</div>

<div id="rollback-modal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="rollback-modal-title" aria-describedby="rollback-modal-description">
    <div class="modal-container">
        <div class="modal-header">
            <h3 id="rollback-modal-title" class="modal-title">‚ö†Ô∏è Rollback Migration</h3>
            <button type="button" class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body">
            <div id="rollback-modal-description" class="warning-box">
                <p><strong>Warning:</strong> Rolling back will undo migration changes. This operation cannot be undone.</p>
            </div>
            <div class="form-group">
                <label for="rollback-phase">Rollback to phase (optional):</label>
                <select id="rollback-phase" class="text fullwidth">
                    <option value="">Complete rollback</option>
                    <option value="7">Phase 7 - Image Transforms</option>
                    <option value="6">Phase 6 - Post-Migration Validation</option>
                    <option value="5">Phase 5 - File Migration</option>
                    <option value="4">Phase 4 - Filesystem Switch</option>
                    <option value="3">Phase 3 - Template Updates</option>
                    <option value="2">Phase 2 - URL Replacement</option>
                    <option value="1">Phase 1 - Pre-Flight Checks</option>
                    <option value="0">Phase 0 - Setup & Configuration</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn secondary modal-close">Cancel</button>
            <button type="button" class="btn error" id="confirm-rollback-btn">Confirm Rollback</button>
        </div>
    </div>
</div>

<div id="live-monitor-modal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="live-monitor-title">
    <div class="modal-container" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="live-monitor-title" class="modal-title">
                <span aria-hidden="true">üìä</span> Live Migration Monitor
                <span id="monitor-status-badge" class="badge" style="margin-left: 10px; display: none;"></span>
            </h3>
            <button type="button" class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body">
            {# No Migration State #}
            <div id="monitor-no-migration" style="display: none;">
                <div class="info-box">
                    <p><strong>No active migration found.</strong></p>
                    <p>Start a migration to see live progress here. The monitor automatically refreshes every 3 seconds.</p>
                </div>
            </div>

            {# Active Migration #}
            <div id="monitor-active" style="display: none;">
                {# Migration Info #}
                <div class="monitor-section">
                    <h4>Migration Information</h4>
                    <div class="monitor-grid">
                        <div class="monitor-item">
                            <span class="monitor-label">Migration ID:</span>
                            <span id="monitor-migration-id" class="monitor-value">-</span>
                        </div>
                        <div class="monitor-item">
                            <span class="monitor-label">Phase:</span>
                            <span id="monitor-phase" class="monitor-value">-</span>
                        </div>
                        <div class="monitor-item">
                            <span class="monitor-label">Status:</span>
                            <span id="monitor-status" class="monitor-value">-</span>
                        </div>
                        <div class="monitor-item">
                            <span class="monitor-label">Process:</span>
                            <span id="monitor-process" class="monitor-value">-</span>
                        </div>
                    </div>
                </div>

                {# Progress Bar #}
                <div class="monitor-section">
                    <h4>Progress</h4>
                    <div class="progress-bar" style="height: 30px; margin-bottom: 10px;">
                        <div id="monitor-progress-fill" class="progress-fill" style="width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span id="monitor-progress-text">0 / 0 items processed</span>
                        <span id="monitor-progress-percent" style="font-weight: bold;">0%</span>
                    </div>
                </div>

                {# Statistics #}
                <div class="monitor-section" id="monitor-stats-section" style="display: none;">
                    <h4>Statistics</h4>
                    <div id="monitor-stats" class="monitor-stats"></div>
                </div>

                {# Recent Logs #}
                <div class="monitor-section">
                    <h4>Task Logs <span style="font-size: 12px; color: #666;">(grouped by recent commands)</span></h4>
                    <div id="monitor-log-tasks" class="monitor-log-tasks"></div>
                </div>

                {# Error Message #}
                <div id="monitor-error-section" class="monitor-section" style="display: none;">
                    <div class="error-box">
                        <h4>Error</h4>
                        <p id="monitor-error-message"></p>
                    </div>
                </div>
            </div>

            {# Loading State #}
            <div id="monitor-loading" style="text-align: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Loading migration data...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn secondary" id="monitor-pause-btn" style="display: none;">
                <span id="monitor-pause-text">Pause Refresh</span>
            </button>
            <button type="button" class="btn secondary modal-close">Close</button>
        </div>
    </div>
</div>

{# Include CSS #}
{% css %}
    {% include 'spaghetti-migrator/css/dashboard.css' %}
{% endcss %}

{# Include JavaScript - Config MUST be set before dashboard.js loads #}
{% set baseAdminUrl = craft.app.config.general.cpTrigger %}
{% js %}
    window.migrationDashboard = {
        csrfToken: '{{ craft.app.request.csrfToken }}',
        actionUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration',
        statusUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/get-status',
        runCommandUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/run-command',
        runCommandQueueUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/run-command-queue',
        getQueueStatusUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/get-queue-status',
        getMigrationProgressUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/get-migration-progress',
        getLiveMonitorUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/get-live-monitor',
        monitorLogLines: 0,
        cancelCommandUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/cancel-command',
        checkpointUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/get-checkpoint',
        logsUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/get-logs',
        testConnectionUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/test-connection',
        changelogUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/get-changelog',
        updateStatusUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/update-status',
        updateModuleStatusUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/update-module-status',
        analyzeMissingFilesUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/analyze-missing-files',
        fixMissingFilesUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/fix-missing-files',
        // SSE Streaming endpoints
        streamMigrationUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/stream-migration',
        cancelStreamingMigrationUrl: '/{{ baseAdminUrl }}/spaghetti-migrator/migration/cancel-streaming-migration',
        // Execution mode: 'queue' or 'sse'
        executionMode: 'sse' // Default to SSE (non-blocking)
    };
{% endjs %}

{% js %}
    {% include 'spaghetti-migrator/js/dashboard.js' %}
{% endjs %}

{% endblock %}
