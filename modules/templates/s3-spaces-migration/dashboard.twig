{% extends "_layouts/cp" %}
{% set title = "AWS to DigitalOcean Migration" %}
{% set fullPageForm = false %}

{% block content %}

<div id="migration-dashboard" class="migration-dashboard">

    {# Header Section #}
    <div class="migration-header">
        <div class="migration-header-content">
            <h1>AWS S3 ‚Üí DigitalOcean Spaces Migration</h1>
            <p class="migration-subtitle">Step-by-step orchestration of your complete cloud storage migration</p>
        </div>

        <div class="migration-header-status">
            <div class="status-badge" data-status="{{ state.currentPhase }}">
                <span class="status-dot"></span>
                <span class="status-text">Phase {{ state.currentPhase }} of 8</span>
            </div>
        </div>
    </div>

    {# Workflow Stepper #}
    <div class="workflow-stepper">
        <div class="stepper-step" data-phase="0">
            <div class="step-number">0</div>
            <div class="step-label">Setup</div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step" data-phase="1">
            <div class="step-number">1</div>
            <div class="step-label">Checks</div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step" data-phase="2">
            <div class="step-number">2</div>
            <div class="step-label">URLs</div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step" data-phase="3">
            <div class="step-number">3</div>
            <div class="step-label">Templates</div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step critical" data-phase="4">
            <div class="step-number">4</div>
            <div class="step-label">Switch FS</div>
            <div class="step-icon" aria-label="Critical step"><span aria-hidden="true">‚ö†Ô∏è</span></div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step critical" data-phase="5">
            <div class="step-number">5</div>
            <div class="step-label">Migrate</div>
            <div class="step-icon" aria-label="Migration step"><span aria-hidden="true">üì¶</span></div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step" data-phase="6">
            <div class="step-number">6</div>
            <div class="step-label">Validate</div>
        </div>
        <div class="stepper-divider"></div>
        <div class="stepper-step" data-phase="7">
            <div class="step-number">7</div>
            <div class="step-label">Transforms</div>
        </div>
    </div>

    {# Critical Order Warning #}
    <div class="order-warning-banner" role="alert">
        <div class="warning-icon" aria-hidden="true">‚ö†Ô∏è</div>
        <div class="warning-content">
            <h4>Critical Workflow Order</h4>
            <p><strong>IMPORTANT:</strong> Phase 4 (Filesystem Switch) MUST be completed BEFORE Phase 5 (File Migration). Switching filesystems first ensures volumes point to DigitalOcean during migration.</p>
        </div>
    </div>

    {# Configuration Status #}
    <div class="config-status-section">
        <div class="config-status-card">
            <h3>Configuration Status</h3>
            <div class="config-status-grid">
                <div class="config-item {{ config.hasDoCredentials ? 'config-ok' : 'config-missing' }}">
                    <span class="config-icon">{{ config.hasDoCredentials ? '‚úì' : '‚úó' }}</span>
                    <span class="config-label">DO Credentials</span>
                </div>
                <div class="config-item {{ config.hasDoBucket ? 'config-ok' : 'config-missing' }}">
                    <span class="config-icon">{{ config.hasDoBucket ? '‚úì' : '‚úó' }}</span>
                    <span class="config-label">DO Bucket</span>
                </div>
                <div class="config-item {{ config.hasAwsConfig ? 'config-ok' : 'config-missing' }}">
                    <span class="config-icon">{{ config.hasAwsConfig ? '‚úì' : '‚úó' }}</span>
                    <span class="config-label">AWS Config</span>
                </div>
                <div class="config-item {{ config.hasDoUrl ? 'config-ok' : 'config-missing' }}">
                    <span class="config-icon">{{ config.hasDoUrl ? '‚úì' : '‚úó' }}</span>
                    <span class="config-label">DO Base URL</span>
                </div>
            </div>

            {% if config.isConfigured %}
            <div class="config-details">
                <div class="config-detail-row">
                    <span class="config-detail-label">AWS Bucket:</span>
                    <span class="config-detail-value">{{ config.awsBucket }}</span>
                </div>
                <div class="config-detail-row">
                    <span class="config-detail-label">DO Bucket:</span>
                    <span class="config-detail-value">{{ config.doBucket }}</span>
                </div>
            </div>
            {% endif %}

            <div class="config-actions">
                <button type="button" class="btn" id="test-connection-btn">Test DO Connection</button>
                <a href="{{ url('settings/filesystems') }}" class="btn secondary">View Filesystems</a>
            </div>
        </div>

        {# Resume Banner #}
        {% if state.canResume %}
        <div class="resume-banner" role="status">
            <div class="resume-banner-icon" aria-hidden="true">‚è∏Ô∏è</div>
            <div class="resume-banner-content">
                <h4>Migration checkpoint detected</h4>
                <p>A previous migration was interrupted. You can resume from where you left off.</p>
            </div>
            <div class="resume-banner-actions">
                <button type="button"
                        class="btn submit run-module-btn"
                        data-command="image-migration/migrate"
                        data-supports-resume="true"
                        data-resume="true">Resume Migration</button>
                <button type="button" class="btn secondary" id="view-checkpoint-btn">View Checkpoint</button>
            </div>
        </div>
        {% endif %}
    </div>

    {# Quick Guide Section #}
    <div class="module-group" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-color: #93c5fd;">
        <div class="module-group-header" style="border-bottom-color: #93c5fd;">
            <span class="module-group-icon" aria-hidden="true">‚ÑπÔ∏è</span>
            <h3 class="module-group-title">How to Use This Dashboard</h3>
        </div>
        <div class="module-group-description" style="margin-bottom: 0;">
            <p style="margin: 0 0 12px 0;"><strong>This dashboard guides you through a complete AWS S3 ‚Üí DigitalOcean Spaces migration.</strong></p>
            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                <li><strong>‚å®Ô∏è Manual CLI steps</strong> require terminal commands and can be marked as completed when done</li>
                <li><strong>‚ñº Collapsible phases</strong> can be expanded/collapsed by clicking the phase header</li>
                <li><strong>‚úì Green checkmarks</strong> indicate completed steps - your progress is automatically saved</li>
                <li><strong>‚ö†Ô∏è Critical steps</strong> must be done in order - the dashboard will warn you if prerequisites are missing</li>
                <li><strong>üìã View logs</strong> button lets you see detailed output from each command</li>
                <li><strong>Progress bar</strong> shows real-time execution progress for running commands</li>
            </ul>
        </div>
    </div>

    {# Migration Steps #}
    <div class="migration-phases">
        {% for phase in modules %}
        <div class="phase-section" data-phase-id="{{ phase.id }}">
            <div class="phase-header">
                <div class="phase-number">Phase {{ phase.phase }}</div>
                <div class="phase-info">
                    <h2 class="phase-title">{{ phase.title }}</h2>
                    <div class="phase-module-count">{{ phase.modules|length }} module{{ phase.modules|length > 1 ? 's' : '' }}</div>
                </div>
            </div>

            <div class="phase-modules">
                {% for module in phase.modules %}
                <div class="module-card {% if module.requiresArgs %}manual-step{% endif %}" data-module-id="{{ module.id }}" data-command="{{ module.command }}">
                    <div class="module-header">
                        <div class="module-status-icon">
                            <span class="status-indicator"></span>
                        </div>
                        <div class="module-info">
                            <h3 class="module-title">
                                {{ module.title }}
                                {% if module.critical %}
                                <span class="badge critical-badge">Critical</span>
                                {% endif %}
                                {% if module.requiresArgs %}
                                <span class="manual-step-badge">
                                    <span aria-hidden="true">‚å®Ô∏è</span> Manual CLI
                                </span>
                                {% endif %}
                            </h3>
                            <div class="module-description">{{ module.description|raw }}</div>
                        </div>
                        <div class="module-meta">
                            <span class="module-duration"><span aria-hidden="true">‚è±Ô∏è</span> {{ module.duration }}</span>
                        </div>
                    </div>

                    <div class="module-actions">
                        {% if module.supportsDryRun and not module.requiresArgs %}
                        <button type="button"
                                class="btn secondary run-module-btn"
                                data-command="{{ module.command }}"
                                data-dry-run="true">
                            Dry Run
                        </button>
                        {% endif %}

                        <button type="button" class="btn icon-only copy-command-btn"
                                {% if module.command %}data-command="php craft s3-spaces-migration/{{ module.command }}"{% endif %}
                                aria-label="Copy CLI command for {{ module.title }}">
                            <span class="log-icon" aria-hidden="true">üìã</span>
                        </button>

                        <button type="button"
                                class="btn submit run-module-btn primary-action-btn"
                                data-command="{{ module.command }}"
                                {% if module.supportsResume %}data-supports-resume="true"{% endif %}
                                {% if module.requiresArgs %}data-manual-step="true"{% endif %}>
                            {% if module.requiresArgs %}
                                ‚úì Mark as Completed
                            {% else %}
                                Run {{ module.title }}
                            {% endif %}
                        </button>
                    </div>

                    {# Progress Section (hidden by default) #}
                    <div class="module-progress" style="display: none;">
                        <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Module execution progress">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-info">
                            <span class="progress-text">Starting...</span>
                            <span class="progress-percent">0%</span>
                        </div>
                        <div class="progress-actions">
                            <button type="button" class="btn small error cancel-module-btn" style="display: none;" aria-label="Cancel module execution">
                                Cancel
                            </button>
                        </div>
                    </div>

                    {# Output Section (hidden by default) #}
                    <div class="module-output" style="display: none;">
                        <div class="output-header">
                            <h4>Output</h4>
                            <button type="button" class="btn small clear-output-btn">Clear</button>
                        </div>
                        <pre class="output-content"></pre>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    {# Rollback Section #}
    <div class="rollback-section">
        <div class="rollback-card">
            <h3><span aria-hidden="true">‚ö†Ô∏è</span> Rollback & Recovery</h3>
            <p>If something goes wrong, you can rollback the migration to a previous state.</p>
            <div class="rollback-actions">
                <button type="button" class="btn error" id="rollback-btn">Rollback Migration</button>
                <button type="button" class="btn secondary" id="view-changelog-btn">View Change Log</button>
            </div>
        </div>
    </div>
</div>

{# Accessibility: Screen reader announcements #}
<div id="sr-announcements" class="sr-only" role="status" aria-live="polite" aria-atomic="true"></div>

{# Modals #}
<div id="output-modal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="output-modal-title" aria-describedby="modal-output-content">
    <div class="modal-container">
        <div class="modal-header">
            <h3 id="output-modal-title" class="modal-title">Command Output</h3>
            <button type="button" class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body">
            <pre id="modal-output-content"></pre>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn secondary modal-close">Close</button>
        </div>
    </div>
</div>

<div id="checkpoint-modal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="checkpoint-modal-title" aria-describedby="checkpoint-list">
    <div class="modal-container">
        <div class="modal-header">
            <h3 id="checkpoint-modal-title" class="modal-title">Migration Checkpoints</h3>
            <button type="button" class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body">
            <div id="checkpoint-list"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn secondary modal-close">Close</button>
        </div>
    </div>
</div>

<div id="rollback-modal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="rollback-modal-title" aria-describedby="rollback-modal-description">
    <div class="modal-container">
        <div class="modal-header">
            <h3 id="rollback-modal-title" class="modal-title">‚ö†Ô∏è Rollback Migration</h3>
            <button type="button" class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body">
            <div id="rollback-modal-description" class="warning-box">
                <p><strong>Warning:</strong> Rolling back will undo migration changes. This operation cannot be undone.</p>
            </div>
            <div class="form-group">
                <label for="rollback-phase">Rollback to phase (optional):</label>
                <select id="rollback-phase" class="text fullwidth">
                    <option value="">Complete rollback</option>
                    <option value="7">Phase 7 - Image Transforms</option>
                    <option value="6">Phase 6 - Post-Migration Validation</option>
                    <option value="5">Phase 5 - File Migration</option>
                    <option value="4">Phase 4 - Filesystem Switch</option>
                    <option value="3">Phase 3 - Template Updates</option>
                    <option value="2">Phase 2 - URL Replacement</option>
                    <option value="1">Phase 1 - Pre-Flight Checks</option>
                    <option value="0">Phase 0 - Setup & Configuration</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn secondary modal-close">Cancel</button>
            <button type="button" class="btn error" id="confirm-rollback-btn">Confirm Rollback</button>
        </div>
    </div>
</div>

{# Include CSS #}
{% css %}
    {% include 's3-spaces-migration/css/dashboard.css' %}
{% endcss %}

{# Include JavaScript - Config MUST be set before dashboard.js loads #}
{% set baseAdminUrl = craft.app.config.general.cpTrigger %}
{% js %}
    window.migrationDashboard = {
        csrfToken: '{{ craft.app.request.csrfToken }}',
        actionUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration',
        statusUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/get-status',
        runCommandUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/run-command',
        runCommandQueueUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/run-command-queue',
        getQueueStatusUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/get-queue-status',
        getMigrationProgressUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/get-migration-progress',
        cancelCommandUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/cancel-command',
        checkpointUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/get-checkpoint',
        logsUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/get-logs',
        testConnectionUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/test-connection',
        changelogUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/get-changelog',
        updateStatusUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/update-status',
        updateModuleStatusUrl: '/{{ baseAdminUrl }}/s3-spaces-migration/migration/update-module-status'
    };
{% endjs %}

{% js %}
    {% include 's3-spaces-migration/js/dashboard.js' %}
{% endjs %}

{% endblock %}
